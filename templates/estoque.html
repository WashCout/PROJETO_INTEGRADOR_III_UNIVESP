<!-- estoque.html COMPLETO -->
{% extends 'base.html' %}
{% load static %}

{% block 'head' %}
  <link rel="stylesheet"
        href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
  <link rel="stylesheet" href="{% static 'geral/css/style.css' %}">
{% endblock %}

{% block 'body' %}
<script src="https://code.responsivevoice.org/responsivevoice.js?key=z1OEV896"></script>

<body class="page-catalog">
  {% include 'navbar.html' %}

  <div class="container-fluid">
    <h1 class="mb-4">Estoque de Produtos da Distribuidora em Itanhaém</h1>
    <h3 class="mb-4">Selecione os produtos para a reserva:</h3>

    <!-- Filtro de Subcategoria -->
    <div class="mb-3">
      <select id="subcategoriaFiltro"
        class="form-select form-select-sm"
        style="max-width: 220px;">   <!-- ajusta a largura -->
  <option value="">Todas as Categorias</option>
        <option value="">Todas as Categorias</option>
        <option value="Paleta">Paleta</option>
        <option value="Picolé Tradicional">Picolé Tradicional</option>
        <option value="Picolé Especial">Picolé Especial</option>
        <option value="Picolé Kids">Picolé Kids</option>
        <option value="Massa 5 Litros">Massa 5 Litros</option>
        <option value="Massa Açaí">Massa Açaí</option>
        <option value="Massa Tradicional">Massa Tradicional</option>
        <option value="Massa Especial">Massa Especial</option>
        <option value="Pote Massa Açaí">Pote Massa Açaí</option>
        <option value="Pote Massa Tradicional">Pote Massa Tradicional</option>
        <option value="Pote Massa Especial">Pote Massa Especial</option>
      </select>
    </div>

    <!-- Tabela de Estoque -->
    <div class="row mb-3 table-responsive">
      <div class="col-lg-8">
        <table id="estoqueTable" class="table table-striped table-sm">
          <thead>
            <tr>
              <th>Código</th>
              <th>Nome</th>
              <th>Categoria</th>
              <th>Subcategoria</th>
              <th>Qtd Disponível</th>          <!-- NOVO -->
              <th>Reservar</th>                <!-- era Quantidade -->
              <th>Valor Unitário</th>
              <th>Ação</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Tabela de Produtos Selecionados -->
      <div class="col-lg-4 table-responsive">
        <h4 class="mb-4">Produtos Selecionados:</h4>
        <table id="selecionadosTable" class="table table-striped table-sm mb-3">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Quantidade</th>
              <th>Valor Total</th>
              <th>Ação</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <!-- Total geral -->
        <div class="d-flex justify-content-between align-items-center mb-3">
          <strong>Total Geral:</strong>
          <strong>R$ <span id="totalGeral">0,00</span></strong>
        </div>

        <button class="btn btn-primary w-100"
                id="finalizarCompraBtn"
                style="border:1px solid #004C22;box-shadow:5px 5px #004C22;">
          Finalizar Reserva
        </button>
      </div>
    </div>
  </div>

  {% include 'footer.html' %}

  <!-- Modal de Confirmação -->
  <div class="modal fade" id="confirmacaoModal" tabindex="-1"
       aria-labelledby="confirmacaoModalLabel" aria-hidden="true">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmacaoModalLabel">Confirmação de Pedido</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"
                aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        Você já tem um pedido em andamento. Tem certeza que quer realizar outro pedido?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Não</button>
        <button type="button" class="btn btn-primary" id="confirmarCompraBtn">Sim</button>
      </div>
    </div></div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
  <script>
    $(function() {

      /* ----------- DATATABLE PRINCIPAL ----------- */
      var table = $('#estoqueTable').DataTable({
        language:{ url:'//cdn.datatables.net/plug-ins/2.0.7/i18n/pt-BR.json' },
        ajax:{ url:"{% url 'api_estoque' %}", dataSrc:'' },
        columns:[
          { data:'codigo' },
          { data:'nome_produto' },
          { data:'categoria' },
          { data:'subcategoria' },
          { data:'quantidade' },                        // Qtd disponível (NOVO)
          {                                           // Campo de reserva
            data:'quantidade',
            render:function(data){ 
              return '<input type="number" class="form-control form-control-sm quantity-picker" '
                     +'min="1" max="'+data+'" value="1">';
            }
          },
          { data:'valor',
            render:function(d){ return 'R$ '+parseFloat(d).toFixed(2).replace('.',','); }
          },
          { data:null,className:"dt-center",
            defaultContent:'<button class="btn btn-primary btn-sm add-to-cart">Adicionar</button>' }
        ]
      });

      /* ---------- FILTRO SUBCATEGORIA ---------- */
      $('#subcategoriaFiltro').on('change', function () {
          table.column(3).search(this.value).draw();
      });

      /* ---------- DATATABLE SELECIONADOS ---------- */
      var selectedTable = $('#selecionadosTable').DataTable({
        language:{ url:'//cdn.datatables.net/plug-ins/2.0.7/i18n/pt-BR.json' },
        paging:false, searching:false, info:false,
        columns:[
          { data:'nome_produto' },
          { data:'quantidade',
            render:function(d){ return '<input type="number" min="1" class="form-control form-control-sm selected-quantity" value="'+d+'">'; }
          },
          { data:'valor',
            render:function(d, type, row){ return 'R$ '+(d*row.quantidade).toFixed(2).replace('.',','); }
          },
          { data:null,className:"dt-center",
            defaultContent:'<button class="btn btn-danger btn-sm remove-from-cart">Remover</button>' }
        ]
      });

      /* ---------- ADICIONAR / REMOVER ---------- */
      $('#estoqueTable tbody').on('click','button.add-to-cart',function(){
          let row = table.row($(this).parents('tr')),
              data=row.data(),
              qtd=$(this).parents('tr').find('.quantity-picker').val();
          if(qtd>data.quantidade){
              alert('Erro: quantidade selecionada excede a disponível.');
              return;
          }
          data.quantidade=qtd;
          selectedTable.row.add(data).draw();
          updateTotal();
      });
      $('#selecionadosTable tbody').on('click','button.remove-from-cart',function(){
          selectedTable.row($(this).parents('tr')).remove().draw();
          updateTotal();
      });

      function updateTotal(){
          let total=0;
          selectedTable.rows().data().each(function(v){
              total+=parseFloat(v.valor)*v.quantidade;
          });
          $('#totalGeral').text(total.toFixed(2).replace('.',','));
      }

      /* ---------- FINALIZAR ---------- */
      $('#finalizarCompraBtn').click(function(){
          if(selectedTable.rows().count()===0){ alert('Selecione ao menos um produto.'); return; }
          let pedido=[];
          selectedTable.rows().data().each(function(v){
              pedido.push({
                  nome_produto:v.nome_produto,
                  quantidade:v.quantidade,
                  valor_unitario:v.valor,
                  valor_total:(v.valor*v.quantidade).toFixed(2)
              });
          });
          $.get('{% url "verificar_pedido" %}',function(resp){
              if(resp.tem_pedido_em_andamento){
                  $('#confirmacaoModal').modal('show');
                  $('#confirmarCompraBtn').one('click',function(){
                      enviar(pedido,true);
                      $('#confirmacaoModal').modal('hide');
                  });
              }else enviar(pedido,false);
          });
      });

      function enviar(pedido,flag){
          $.post('{% url "finalizar_compra" %}',{
              pedido:JSON.stringify(pedido),
              tem_pedido_em_andamento:flag,
              csrfmiddlewaretoken:'{{ csrf_token }}'
          }).done(function(){
              alert('Reserva finalizada com sucesso!');
              selectedTable.clear().draw(); updateTotal();
          }).fail(function(){ alert('Erro ao finalizar a reserva.'); });
      }

    });
  </script>
</body>
{% endblock %}
